/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";
import React, { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import { useMutation, useLazyQuery } from "@apollo/client";
import apolloClient from "@frontend/apollo-client";
import { useDispatch } from "react-redux";
import {
  RESEND_OTP_MUTATION,              // user: resendOtp
  VERIFY_SIGN_OTP_MUTATION,         // user: verifyOtpForSignIn
  ADMIN_VERIFY_SIGNIN_OTP_MUTATION, // admin: adminverifyOtpForSignIn
  ADMIN_RESEND_OTP_MUTATION,        // admin: adminresendOtp
} from "../../../graphql/mutations/auth";
import { GET_BY_ROLE } from "../../../graphql/queries/role";
import { GET_USER } from "../../../graphql/queries/user";
import { GET_ADMIN_USER } from "../../../graphql/queries/adminUser";
import { REGISTER_DEVICE_TOKEN_MUTATION } from "../../../graphql/mutations/auth";
import { getInputType, normalizeMobileNumber } from "@frontend/shared-utils";
import { getFCMToken } from "../../../../../../apps/user-portal/src/utils/firebase"
import {
  VerifyOtpInput,
  ResendOtpInput,
} from "../../../../../shared-types/src/auth/auth.types";
import {
  Box,
  Typography,
  TextField,
  CircularProgress,
} from "@mui/material";
import { Inter } from "next/font/google";
import { toast } from "react-toastify";

// Shared UI
import AuthLayout from "../_shared/AuthLayout";
import HeaderLogo from "../_shared/HeaderLogo";
import AuthButton from "../_shared/AuthButton";
import AuthFooterNote from "../_shared/AuthFooterNote";
import RightImage from "../_shared/RightImage";
import { getDefaultLandingPage } from "../../../../../../libs/shared-ui/src/utils/getDefaultLandingPage";


const inter = Inter({ subsets: ["latin"], weight: ["400", "500", "600", "700"] });

// Use props like the Sign In page
interface OTPPageProps {
  type?: "user" | "admin";
}

// Note: Do not import app-specific slices from a shared library.
// The admin portal is responsible for fetching its own admin user data after navigation.

const OTPPage: React.FC<OTPPageProps> = ({ type }) => {
  const [otp, setOtp] = useState<string[]>(Array(6).fill(""));
  const [timer, setTimer] = useState(90);
  const [isResendEnabled, setIsResendEnabled] = useState(false);
  const [error, setError] = useState("");
  const [shake, setShake] = useState(false);
  const [redirecting, setRedirecting] = useState(false);
  const [inputType, setInputType] = useState<'email' | 'mobile' | 'unknown'>('unknown');

  const router = useRouter();
  const dispatch = useDispatch<any>();


  const urlParams =
    typeof window !== "undefined"
      ? new URLSearchParams(window.location.search)
      : new URLSearchParams();

  // Support both 'email' and 'emailOrPhone' parameters for backward compatibility
  const emailOrPhoneParams = urlParams.get("emailOrPhone") || urlParams.get("email");
  const flowParams = urlParams.get("flow") || "signup";

  // Detect input type when component mounts
  useEffect(() => {
    if (emailOrPhoneParams) {
      setInputType(getInputType(emailOrPhoneParams));
    }
  }, [emailOrPhoneParams]);

  // USER verify mutation
  const [verifyUserOtp, { loading: userVerifyLoading }] = useMutation(VERIFY_SIGN_OTP_MUTATION);
  // ADMIN verify mutation
  const [verifyAdminOtp, { loading: adminVerifyLoading }] = useMutation(ADMIN_VERIFY_SIGNIN_OTP_MUTATION);

  // USER resend mutation
  const [resendUserOtp, { loading: resendUserLoading }] = useMutation(RESEND_OTP_MUTATION);
  // ADMIN resend mutation
  const [resendAdminOtp, { loading: resendAdminLoading }] = useMutation(ADMIN_RESEND_OTP_MUTATION);

  // Add role query
  const [getByRole] = useLazyQuery(GET_BY_ROLE);
  const [registerDeviceToken] = useMutation(REGISTER_DEVICE_TOKEN_MUTATION);

  const loadingVerify = userVerifyLoading || adminVerifyLoading;
  const resendLoading = resendUserLoading || resendAdminLoading;

  // Primary: from props; Fallback: runtime host/path (keeps old behavior intact)
  const isAdminFromProp = type === "admin";
  const runtimeAdmin =
    typeof window !== "undefined" &&
    (window.location.pathname.includes("/admin") || window.location.hostname.includes("admin"));
  const isAdminPortal = Boolean(isAdminFromProp || runtimeAdmin);

  // Timer countdown
  useEffect(() => {
    if (timer > 0) {
      const interval = setInterval(() => setTimer((prev) => prev - 1), 1000);
      return () => clearInterval(interval);
    } else {
      setIsResendEnabled(true);
    }
  }, [timer]);

  const handleChange = (value: string, index: number) => {
    if (/^[0-9]?$/.test(value)) {
      const next = [...otp];
      next[index] = value;
      setOtp(next);
      setError("");
      if (value && index < 5) {
        document.getElementById(`otp-${index + 1}`)?.focus();
      }
    }
  };

  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>, index: number) => {
    if (e.key === "Backspace" && !otp[index] && index > 0) {
      document.getElementById(`otp-${index - 1}`)?.focus();
    }
  };

  const handlePaste = (e: React.ClipboardEvent<HTMLInputElement>) => {
    const pasteData = e.clipboardData.getData("Text").slice(0, 6);
    if (/^\d+$/.test(pasteData)) {
      const next = pasteData.split("").concat(Array(6 - pasteData.length).fill(""));
      setOtp(next);
      setError("");
    }
    e.preventDefault();
  };

  const handleResend = async () => {
    try {
      if (!emailOrPhoneParams) {
        toast.error("Email or mobile number not found. Please try signing up again.");
        router.push("/auth/signup");
        return;
      }
      const normalizedEmailOrPhone = getInputType(emailOrPhoneParams) === 'mobile' 
        ? normalizeMobileNumber(emailOrPhoneParams) 
        : emailOrPhoneParams;

      const input: ResendOtpInput = { emailOrPhone: normalizedEmailOrPhone };

      let result: any | undefined;
      if (isAdminPortal) {
        const response = await resendAdminOtp({ variables: { input } });
        result = response?.data?.adminresendOtp;
      } else {
        const response = await resendUserOtp({ variables: { input } });
        result = response?.data?.resendOtp;
      }

      if (result?.status === "success") {
        setOtp(Array(6).fill(""));
        setTimer(90);
        setIsResendEnabled(false);
        setError("");
        toast.success(result.message || "OTP has been resent successfully!");
      } else {
        toast.error(result?.message || "Failed to resend OTP. Please try again.");
      }
    } catch (err) {
      console.error("Resend OTP error:", err);
      toast.error("An unexpected error occurred. Please try again.");
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    const otpCode = otp.join("");
    if (otpCode.length !== 6) return;
    setError("");

    try {
      if (!emailOrPhoneParams) {
        toast.error("Email or mobile number not found. Please try again.");
        router.push("/auth/signup");
        return;
      }

      const normalizedEmailOrPhone = getInputType(emailOrPhoneParams) === 'mobile' 
        ? normalizeMobileNumber(emailOrPhoneParams) 
        : emailOrPhoneParams;

      const input: VerifyOtpInput = { emailOrPhone: normalizedEmailOrPhone, otpCode };

      // Choose API based on portal â€” unchanged behavior
      let result: any | undefined;

      if (isAdminPortal) {
        const response = await verifyAdminOtp({ variables: { input } });
        result = response?.data?.adminverifyOtpForSignIn;
      } else {
        const response = await verifyUserOtp({ variables: { input } });
        result = response?.data?.verifyOtpForSignIn;
      }

      if (result?.status === "error" || result?.error) {
        toast.error(result?.message || "Invalid OTP. Please try again.");
        setShake(true);
        setTimeout(() => setShake(false), 500);
        return;
      }

      if (result?.status === "success") {
        toast.success(result?.message || "OTP verified successfully!");

        if (flowParams === "signin") {
          setRedirecting(true);
          let roleData = null; // Declare roleData at the top of the try block scope
          try {
            const token = result.data?.token;
            const userInfo = result.data?.user;

            if (token && userInfo) {
              const portalType = isAdminPortal ? "admin" : "user";
              const user = { ...userInfo, role: portalType };
              
              // Store auth credentials first
              dispatch({ type: "auth/setCredentials", payload: { token, user } });
              console.log('ðŸª Store updated - Auth credentials stored:', { token: !!token, user: user });

              // Fetch role data
              try {
                console.log('ðŸ” Fetching role data after successful authentication...');
                const roleResponse = await getByRole();
                
                if (roleResponse?.data?.getByRole?.status === "success") {
                  roleData = roleResponse.data.getByRole.data;
                  console.log('âœ… Role data fetched successfully:', roleData);
                  dispatch({ type: "role/setRoleData", payload: roleData });
                } else {
                  console.error('âŒ Failed to fetch role data:', roleResponse?.data?.getByRole?.message);
                  dispatch({ type: "role/setRoleError", payload: roleResponse?.data?.getByRole?.message || "Failed to fetch role data" });
                }
              } catch (roleError) {
                console.error('âŒ Error fetching role data:', roleError);
                dispatch({ type: "role/setRoleError", payload: "Failed to fetch role data" });
              }

               // Fetch additional user data using GraphQL queries
               if (!isAdminPortal) {
                 // For user portal, fetch user data using GraphQL
                 try {
                   console.log('ðŸ” Fetching detailed user data for user portal...');
                   const { data: userData } = await apolloClient.query({
                     query: GET_USER,
                     fetchPolicy: 'network-only'
                   });
                   
                   if (userData?.getUser?.status === 'success') {
                     const userDetail = {
                       ...userData.getUser.data.user,
                       isAuthenticated: true,
                       role: { name: userData.getUser.data.user.role }
                     };
                     dispatch({ type: "user/setUserData", payload: userDetail });
                     console.log('âœ… User data fetched and stored successfully');
                   } else {
                     console.error('âŒ Failed to fetch user data:', userData?.getUser?.message);
                   }
                 } catch (userError) {
                   console.error('âŒ Error fetching user data:', userError);
                 }
               } else {
                 // For admin portal, fetch admin user data using GraphQL
                 try {
                   console.log('ðŸ” Fetching detailed admin user data for admin portal...');
                   const { data: adminUserData } = await apolloClient.query({
                     query: GET_ADMIN_USER,
                     fetchPolicy: 'network-only'
                   });
                   
                   if (adminUserData?.getAdminUser?.status === 'success') {
                     const adminUserDetail = {
                       ...adminUserData.getAdminUser.data.user,
                       isAuthenticated: true
                     };
                     dispatch({ type: "adminUser/setAdminUserData", payload: adminUserDetail });
                     console.log('âœ… Admin user data fetched and stored successfully');
                   } else {
                     console.error('âŒ Failed to fetch admin user data:', adminUserData?.getAdminUser?.message);
                   }
                 } catch (adminUserError) {
                   console.error('âŒ Error fetching admin user data:', adminUserError);
                 }
               }
            }
            // If this is user portal, register device token after successful OTP sign-in
            try {
              if (!isAdminPortal) {
                console.log('ðŸ” Registering device token for user portal...Failed');
                const fcmToken = await getFCMToken();
                const userId = userInfo?.id || userInfo?._id || userInfo?.userId;
                if (fcmToken && userId) {
                  await registerDeviceToken({ variables: { userId, deviceToken: fcmToken } });
                }
              }
            } catch (e) {
              console.warn('registerDeviceToken failed (non-blocking):', e);
            }

            // For admin portal, use getDefaultLandingPage. For user portal, always go to dashboard
            if (isAdminPortal) {
              const defaultPage = getDefaultLandingPage(roleData);
              router.push(defaultPage);
            } else {
              router.push("/dashboard");
            }
          } catch (err) {
            console.error("Error storing credentials:", err);
            // For admin portal, use getDefaultLandingPage. For user portal, always go to dashboard
            if (isAdminPortal) {
              const defaultPage = getDefaultLandingPage(null);
              router.push(defaultPage);
            } else {
              router.push("/dashboard");
            }
          }
        } else if (flowParams === "signup") {
          router.push(
            `/auth/create-password?emailOrPhone=${encodeURIComponent(emailOrPhoneParams)}&flow=${flowParams}`
          );
        }
      } else {
        toast.error(result?.message || "Verification failed. Please try again.");
        setShake(true);
        setTimeout(() => setShake(false), 500);
      }
    } catch (err) {
      console.error("OTP Verification error:", err);
      toast.error("An unexpected error occurred. Please try again.");
      setShake(true);
      setTimeout(() => setShake(false), 500);
    }
  };

  const isOtpComplete = otp.join("").length === 6;

  return (
    <AuthLayout
      header={<HeaderLogo />}
      footer={<AuthFooterNote />}
      right={<RightImage />}
    >
      <Box
        component="form"
        onSubmit={handleSubmit}
        className={inter.className}
        sx={{
          width: "100%",
          maxWidth: { xs: "100%", sm: 420 },
          display: "flex",
          flexDirection: "column",
          gap: { xs: 1.5, sm: 2 },
          py: { xs: 1, sm: 2 },
          px: { xs: 2, sm: 0 },
          position: "relative",
          zIndex: 1,
          mx: "auto",
        }}
      >
        {/* Title */}
        <Box textAlign="center">
          <Typography
            fontWeight={700}
            fontSize={{ xs: "clamp(16px,1.8vw,20px)", lg: "20px" }}
            color="#3D3D3D"
          >
            OTP Verification
          </Typography>
          <Typography fontSize="clamp(11px,1.3vw,16px)" color="#6b7280">
            Please enter the 6 digit code sent to {inputType === 'mobile' ? 'your mobile number' : 'your email'}
          </Typography>
        </Box>

        {/* OTP Inputs */}
        <Box
          display="flex"
          justifyContent="center"
          gap={{ xs: 0.8, sm: 1.5 }}
          className={shake ? "shake" : ""}
          mb={1}
          px={{ xs: 1, sm: 0 }}
          sx={{
            width: "100%",
            maxWidth: { xs: "100%", sm: "420px" },
            mx: "auto"
          }}
        >
          {otp.map((digit, idx) => (
            <TextField
              key={idx}
              id={`otp-${idx}`}
              value={digit}
              onChange={(e) => handleChange(e.target.value, idx)}
              onKeyDown={(e: any) => handleKeyDown(e, idx)}
              onPaste={idx === 0 ? handlePaste : undefined}
              inputProps={{
                maxLength: 1,
                style: {
                  textAlign: "center",
                  fontWeight: 600,
                },
                disabled: loadingVerify,
              }}
              sx={{
                width: { xs: "40px", sm: "48px" },
                minWidth: { xs: "40px", sm: "48px" },
                "& .MuiOutlinedInput-root": {
                  borderRadius: "8px",
                  height: { xs: "48px", sm: "56px" },
                  "& fieldset": { borderColor: "#a8a8a8" },
                  "&:hover fieldset": { borderColor: "#808080" },
                  "&.Mui-focused fieldset": { borderColor: "#4285F4" },
                },
                "& .MuiOutlinedInput-input": {
                  padding: { xs: "8px", sm: "12px" },
                  fontSize: { xs: "1.2rem", sm: "1.5rem" },
                },
              }}
            />
          ))}
        </Box>

        {error && (
          <Typography color="error" textAlign="center" fontSize="0.9rem">
            {error}
          </Typography>
        )}

        {/* Continue button (shared) */}
        <AuthButton
          text="Continue"
          loadingText={redirecting ? "Redirecting..." : "Verifying..."}
          loading={loadingVerify || redirecting}
          disabled={!isOtpComplete || loadingVerify || redirecting}
          fullWidth
        />

        {/* Resend OTP */}
        <Typography
          textAlign="center"
          color="#6b7280"
          mt={1}
          fontSize="clamp(11px,1.3vw,16px)"
        >
          Didn&apos;t receive the code?{" "}
          {isResendEnabled ? (
            <Typography
              component="span"
              sx={{
                color: resendLoading ? "#ccc" : "#4285F4",
                fontWeight: 500,
                cursor: resendLoading ? "not-allowed" : "pointer",
              }}
              onClick={resendLoading ? undefined : handleResend}
            >
              {resendLoading ? (
                <>
                  Resending...
                  <CircularProgress size={12} sx={{ ml: 0.5 }} />
                </>
              ) : (
                "Resend"
              )}
            </Typography>
          ) : (
            <span>
              Resend in{" "}
              <span style={{ color: "#4285F4", fontWeight: 500 }}>
                {`${Math.floor(timer / 60)
                  .toString()
                  .padStart(2, "0")}:${(timer % 60).toString().padStart(2, "0")}`}
              </span>
            </span>
          )}
        </Typography>

        {/* Try another way */}
        <Typography
          sx={{
            color: "#6b7280",
            textDecoration: "underline",
            cursor: "pointer",
            textAlign: "center",
            fontSize: "clamp(11px,1.3vw,16px)",
          }}
          onClick={() => router.push("/auth/signin")}
        >
          Try another way?
        </Typography>
      </Box>

      {/* Shake animation (same as your original) */}
      <style jsx global>{`
        .shake {
          animation: shake 0.4s ease;
        }
        @keyframes shake {
          0% { transform: translateX(0px); }
          25% { transform: translateX(-4px); }
          50% { transform: translateX(4px); }
          75% { transform: translateX(-4px); }
          100% { transform: translateX(0px); }
        }
      `}</style>
    </AuthLayout>
  );
};

export default OTPPage;