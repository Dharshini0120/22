/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";
import React, { useState, useEffect } from 'react';
import {
  Box,
  Button,
  Typography,
  MenuItem,
  Select,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  InputLabel,
  FormControl,
  TextField,
  Chip,
  useTheme,
  InputBase,
  Card,
  CardContent
} from '@mui/material';
import { alpha } from '@mui/material/styles';
import {
  Search as SearchIcon
} from '@mui/icons-material';
import { useRouter, useSearchParams } from 'next/navigation';
import DashboardLayout from '../../components/layout/DashboardLayout';
import { withPageLoader, CustomPagination } from "@frontend/shared-ui";
import { CircularProgress } from '@mui/material';
import { useQuery } from '@apollo/client';
import { GET_TRANSACTIONS_QUERY, GetTransactionsData, GetTransactionsVariables } from '../../graphql/transactions.service';

// Status chip styles matching the requirements
const statusStyles: any = {
  succeeded: {
    backgroundColor: '#E6F7EC',
    color: '#22C55E',
    fontWeight: 500,
    borderRadius: '4px',
    padding: '4px 8px',
    width: '120px',
    textAlign: 'center',
    fontSize: '12px',
    margin: '0 auto',
    display: 'inline-block'
  },
  'requires_confirmation': {
    backgroundColor: '#fff3cd',
    color: '#d8a714',
    fontWeight: 500,
    borderRadius: '4px',
    padding: '4px 8px',
    width: '150px',
    textAlign: 'center',
    fontSize: '12px',
    margin: '0 auto',
    display: 'inline-block'
  },
  failed: {
    backgroundColor: '#ffebee',
    color: '#d33333',
    fontWeight: 500,
    borderRadius: '4px',
    padding: '4px 8px',
    width: '120px',
    textAlign: 'center',
    fontSize: '12px',
    margin: '0 auto',
    display: 'inline-block'
  }
};

const TransactionsPage = () => {
  const [status, setStatus] = useState('');
  const [sortBy, setSortBy] = useState('');
  const [searchQuery, setSearchQuery] = useState('');
  const [fromDate, setFromDate] = useState('');
  const [toDate, setToDate] = useState('');
  const [currentPage, setCurrentPage] = useState(1);
  const [rowsPerPage, setRowsPerPage] = useState(10);

  const theme = useTheme();
  const router = useRouter();
  const searchParams = useSearchParams();
  const userId = searchParams.get('userId');

  // Fetch transactions data
  const { data: transactionsData, loading, refetch } = useQuery<GetTransactionsData, GetTransactionsVariables>(
    GET_TRANSACTIONS_QUERY,
    {
      variables: {
        page: currentPage,
        limit: rowsPerPage,
        userId: userId || undefined
      },
      fetchPolicy: 'network-only'
    }
  );

  const transactions = transactionsData?.getTransactions?.data?.transactions || [];
  const pagination = transactionsData?.getTransactions?.data?.pagination || {
    currentPage: 1,
    totalPages: 1,
    totalCount: 0,
    hasNextPage: false,
    hasPrevPage: false
  };

  // Refetch data when pagination changes
  useEffect(() => {
    refetch({
      page: currentPage,
      limit: rowsPerPage,
      userId: userId || undefined
    });
  }, [currentPage, rowsPerPage, refetch, userId]);

  const handleRowsPerPageChange = (newRowsPerPage: number) => {
    setRowsPerPage(newRowsPerPage);
    setCurrentPage(1);
  };

  const formatStatus = (s: string) => {
    switch (s) {
      case 'succeeded': return 'Succeeded';
      case 'requires_confirmation': return 'Requires Confirmation';
      case 'failed': return 'Failed';
      default: return s;
    }
  };

  const formatDate = (dateString: string) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      hour12: true
    });
  };

  const formatAmount = (amount: string, currency: string) => {
    const numAmount = parseFloat(amount);
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: currency.toUpperCase()
    }).format(numAmount);
  };

  const handleApplyFilters = () => {
    // Reset to first page when applying filters
    setCurrentPage(1);
    refetch({
      page: 1,
      limit: rowsPerPage,
      userId: userId || undefined
    });
  };

  const handleResetFilters = () => {
    setStatus('');
    setSortBy('');
    setSearchQuery('');
    setFromDate('');
    setToDate('');
    setCurrentPage(1);
    refetch({
      page: 1,
      limit: rowsPerPage,
      userId: userId || undefined
    });
  };

  return (
    <DashboardLayout>
      <Box sx={{ width: '81%', margin: '0' }}>
        {/* Header */}
        <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', mb: 3 }}>
          <Box>
            <Typography variant="h5" fontWeight={600} fontFamily={'var(--font-inter), sans-serif'}>
              Transactions
            </Typography>
            <Typography variant="subtitle1" color="#6c757d" fontFamily={'var(--font-inter), sans-serif'}>
              View and manage all payments and invoices for users across facilities
            </Typography>
          </Box>

          {/* Search Field - DashboardHeader style */}
          <Box
            sx={{
              position: "relative",
              borderRadius: 2,
              backgroundColor: alpha(theme.palette.common.black, 0.0),
              "&:hover": {
                backgroundColor: alpha(theme.palette.common.black, 0.1),
              },
              marginRight: theme.spacing(2),
              marginLeft: 0,
              width: "100%",
              maxWidth: 300,
              border: `1px solid ${alpha(theme.palette.common.black, 0.12)}`,
            }}
          >
            <Box
              sx={{
                padding: theme.spacing(0, 2),
                height: "100%",
                position: "absolute",
                pointerEvents: "none",
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
              }}
            >
              <SearchIcon />
            </Box>
            <InputBase
              placeholder="Searchâ€¦"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              sx={{
                color: "inherit",
                width: "100%",
                "& .MuiInputBase-input": {
                  padding: theme.spacing(1, 1, 1, 0),
                  paddingLeft: `calc(1em + ${theme.spacing(4)})`,
                  transition: theme.transitions.create("width"),
                  width: "100%",
                },
              }}
            />
          </Box>
        </Box>

        <Box sx={{ border: '1px solid #e4e5e7', borderRadius: '10px', padding: 3, backgroundColor: '#fff' }}>
          {/* Filters Layout */}
          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', mb: 2 }}>
            {/* Left side - Status and Sort filters */}
            <Box sx={{ display: 'flex', gap: 2, alignItems: 'center' }}>
              <FormControl sx={{ minWidth: 180 }}>
                <InputLabel>Status</InputLabel>
                <Select
                  value={status}
                  label="Status"
                  style={{ borderRadius: '12px', height: '50px' }}
                  onChange={(e) => setStatus(e.target.value)}
                >
                  <MenuItem value="">All</MenuItem>
                  <MenuItem value="succeeded">Succeeded</MenuItem>
                  <MenuItem value="requires confirmation">Requires Confirmation</MenuItem>
                  <MenuItem value="failed">Failed</MenuItem>
                </Select>
              </FormControl>

              <FormControl sx={{ minWidth: 180 }}>
                <InputLabel>Sort By</InputLabel>
                <Select
                  value={sortBy}
                  label="Sort By"
                  style={{ borderRadius: '12px', height: '50px' }}
                  onChange={(e) => setSortBy(e.target.value)}
                >
                  <MenuItem value="most recent">Most Recent</MenuItem>
                  <MenuItem value="oldest">Oldest</MenuItem>
                </Select>
              </FormControl>
            </Box>

            {/* Right side - Date pickers in a card */}
            <Card sx={{ border: '1px solid #e0e0e0', boxShadow: 1 }}>
              <CardContent sx={{ p: 2, '&:last-child': { pb: 2 } }}>
                <Box sx={{ display: 'flex', gap: 2, alignItems: 'center' }}>
                  <FormControl sx={{ minWidth: 140 }}>
                    <TextField
                      label="From:"
                      type="date"
                      value={fromDate}
                      onChange={(e) => setFromDate(e.target.value)}
                      InputLabelProps={{
                        shrink: true,
                      }}
                      size="small"
                      sx={{
                        '& .MuiOutlinedInput-root': {
                          borderRadius: '8px'
                        }
                      }}
                    />
                  </FormControl>

                  <FormControl sx={{ minWidth: 140 }}>
                    <TextField
                      label="To:"
                      type="date"
                      value={toDate}
                      onChange={(e) => setToDate(e.target.value)}
                      InputLabelProps={{
                        shrink: true,
                      }}
                      size="small"
                      sx={{
                        '& .MuiOutlinedInput-root': {
                          borderRadius: '8px'
                        }
                      }}
                    />
                  </FormControl>

                  <Button
                    variant="contained"
                    onClick={handleApplyFilters}
                    size="small"
                    sx={{
                      backgroundColor: '#4285F4',
                      borderRadius: '8px',
                      px: 2,
                      fontWeight: 600,
                      textTransform: 'none',
                      '&:hover': { backgroundColor: '#3576e6' }
                    }}
                  >
                    Apply
                  </Button>

                  <Button
                    variant="text"
                    onClick={handleResetFilters}
                    size="small"
                    sx={{
                      color: '#6c757d',
                      textTransform: 'none',
                      fontWeight: 500,
                      '&:hover': { backgroundColor: 'transparent', textDecoration: 'underline' }
                    }}
                  >
                    Reset
                  </Button>
                </Box>
              </CardContent>
            </Card>
          </Box>

          {/* Table */}
          <TableContainer
            sx={{
              mt:2,
              borderRadius: '12px',
              overflow: 'auto',
              maxHeight: '600px',
              border: '1px solid #e0e0e0'
            }}
          >
            <Table sx={{ minWidth: 1400 }} stickyHeader>
              <TableHead>
                <TableRow>
                  <TableCell sx={{ whiteSpace: 'nowrap', backgroundColor: '#f5f9ff' }}><strong>Transaction ID</strong></TableCell>
                  <TableCell sx={{ whiteSpace: 'nowrap', backgroundColor: '#f5f9ff' }}><strong>Transaction Date</strong></TableCell>
                  <TableCell sx={{ whiteSpace: 'nowrap', backgroundColor: '#f5f9ff' }}><strong>Assessment Name</strong></TableCell>
                  <TableCell sx={{ whiteSpace: 'nowrap', backgroundColor: '#f5f9ff' }}><strong>Assessment Date</strong></TableCell>
                  <TableCell sx={{ whiteSpace: 'nowrap', backgroundColor: '#f5f9ff' }}><strong>Facility Name</strong></TableCell>
                  <TableCell sx={{ whiteSpace: 'nowrap', backgroundColor: '#f5f9ff' }}><strong>User Name</strong></TableCell>
                  <TableCell sx={{ whiteSpace: 'nowrap', backgroundColor: '#f5f9ff' }}><strong>User Email</strong></TableCell>
                  <TableCell sx={{ whiteSpace: 'nowrap', backgroundColor: '#f5f9ff' }}><strong>Amount</strong></TableCell>
                  <TableCell sx={{ whiteSpace: 'nowrap', backgroundColor: '#f5f9ff' }}><strong>Status</strong></TableCell>
                  <TableCell sx={{ whiteSpace: 'nowrap', backgroundColor: '#f5f9ff' }}><strong>Invoice ID</strong></TableCell>
                  <TableCell sx={{ whiteSpace: 'nowrap', backgroundColor: '#f5f9ff' }}><strong>Invoice</strong></TableCell>
                </TableRow>
              </TableHead>
              <TableBody>
                {loading ? (
                  <TableRow>
                    <TableCell colSpan={11} align="center" sx={{ py: 4 }}>
                      <CircularProgress size={40} />
                    </TableCell>
                  </TableRow>
                ) : transactions.length === 0 ? (
                  <TableRow>
                    <TableCell colSpan={11} align="center" sx={{ py: 4 }}>
                      <Typography variant="h6" color="#6c757d" fontWeight={600}>
                        No Record Found
                      </Typography>
                    </TableCell>
                  </TableRow>
                ) : (
                  transactions.map((transaction: any) => (
                    <TableRow key={transaction.id}>
                      <TableCell sx={{ whiteSpace: 'nowrap' }}>{transaction.id}</TableCell>
                      <TableCell sx={{ whiteSpace: 'nowrap' }}>{formatDate(transaction.updatedAt)}</TableCell>
                      <TableCell sx={{ whiteSpace: 'nowrap' }}>{transaction.assessmentName}</TableCell>
                      <TableCell sx={{ whiteSpace: 'nowrap' }}>{formatDate(transaction.assessmentDate)}</TableCell>
                      <TableCell sx={{ whiteSpace: 'nowrap' }}>{transaction.facilityName}</TableCell>
                      <TableCell sx={{ whiteSpace: 'nowrap' }}>{transaction.username}</TableCell>
                      <TableCell sx={{ whiteSpace: 'nowrap' }}>{transaction.useremail}</TableCell>
                      <TableCell sx={{ whiteSpace: 'nowrap' }}>{formatAmount(transaction.amount, transaction.currency)}</TableCell>
                      <TableCell sx={{ whiteSpace: 'nowrap' }}>
                        <Box sx={statusStyles[transaction.status.toLowerCase()]}>
                          {formatStatus(transaction.status)}
                        </Box>
                      </TableCell>
                      <TableCell sx={{ whiteSpace: 'nowrap' }}>{transaction.stripeInvoiceId}</TableCell>
                      <TableCell sx={{ whiteSpace: 'nowrap' }}>
                        <Typography
                          component="a"
                          href={transaction.invoicePdf}
                          target="_blank"
                          rel="noopener noreferrer"
                          sx={{
                            color: '#408bff',
                            textDecoration: 'none',
                            cursor: 'pointer',
                            fontFamily: 'var(--font-inter), sans-serif',
                            fontSize: '14px',
                            fontWeight: 500,
                            '&:hover': {
                              textDecoration: 'underline'
                            }
                          }}
                        >
                          Download Invoice
                        </Typography>
                      </TableCell>
                    </TableRow>
                  ))
                )}
              </TableBody>
            </Table>
          </TableContainer>

          {/* Pagination */}
          <CustomPagination
            currentPage={currentPage}
            totalPages={pagination.totalPages}
            rowsPerPage={rowsPerPage}
            totalItems={pagination.totalCount}
            onPageChange={setCurrentPage}
            onRowsPerPageChange={handleRowsPerPageChange}
            rowsPerPageOptions={[5, 10, 20]}
          />
        </Box>
      </Box>
    </DashboardLayout>
  );
};

export default withPageLoader(TransactionsPage);

