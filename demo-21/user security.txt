"use client";
import React, { useState } from 'react'
import {
    Button,
    Typography,
    Box,
    TextField,
    Grid,
    IconButton,
    InputAdornment,
    Switch,
    FormControlLabel,
    Card,
    CardContent,
    CircularProgress
} from '@mui/material'
import {
    Visibility,
    VisibilityOff,
    Lock,
    Shield
} from '@mui/icons-material'
import { useMutation } from '@apollo/client'
import { useSelector, useDispatch } from 'react-redux'
import type { AppDispatch } from '../../store/store'
import { toast } from 'react-toastify'
import DashboardLayout from '../../components/layout/DashboardLayout'
import { withPageLoader } from '@frontend/shared-ui'
import PasswordStrengthChecker from '../../components/PasswordStrengthChecker'
import { CHANGE_PASSWORD_MUTATION } from '../../graphql/mutations/password'
import { ChangePasswordInput } from '../../types/password.types'
import { setLastPasswordChanged } from '../../store/passwordSlice'
import { userEditService, UserEditInput } from '../../graphql/user.service'
import { updateUser2FA } from '../../store/authSlice'
import { getUser } from '../../store/userSlice'

function Security() {
    const [passwordData, setPasswordData] = useState({
        currentPassword: '',
        newPassword: '',
        confirmPassword: ''
    })

    const [showPasswords, setShowPasswords] = useState({
        current: true,
        new: true,
        confirm: true
    })

    // Get 2FA state from Redux store
    const twoFactorEnabled = useSelector((state: any) => state.auth?.user?.is2FA || false)

    const [errors, setErrors] = useState({
        currentPassword: '',
        newPassword: '',
        confirmPassword: ''
    })

    // Get user info and last password changed from Redux store
    const userInfo = useSelector((state: any) => state.auth?.user)
    const lastChangedDate = useSelector((state: any) => state.password?.lastPasswordChanged)
    const dispatch = useDispatch<AppDispatch>()
    
    // GraphQL mutations
    const [changePassword, { loading: passwordLoading }] = useMutation(CHANGE_PASSWORD_MUTATION)
    const [userEditLoading, setUserEditLoading] = useState(false)




    const handlePasswordChange = (e: any) => {
        const { name, value } = e.target
        setPasswordData(prev => ({ ...prev, [name]: value }))
        if (errors[name as keyof typeof errors]) {
            setErrors(prev => ({ ...prev, [name]: '' }))
        }
    }

    const validatePassword = () => {
        let isValid = true
        const newErrors = { ...errors }



        if (!passwordData.newPassword || passwordData.newPassword.length < 6) {
            newErrors.newPassword = 'New password must be at least 6 characters'
            isValid = false
        }

        if (passwordData.newPassword !== passwordData.confirmPassword) {
            newErrors.confirmPassword = 'Passwords do not match'
            isValid = false
        }
        
        if (!passwordData.currentPassword) {
            newErrors.currentPassword = 'Current password is required'
            isValid = false
        }

        if (!passwordData.newPassword) {
            newErrors.newPassword = 'New password is required'
            isValid = false
        }

        if (!passwordData.confirmPassword) {
            newErrors.confirmPassword = 'Confirm password is required'
            isValid = false
        }



        setErrors(newErrors)
        return isValid
    }

    const handlePasswordSubmit = async (e: React.FormEvent) => {
        e.preventDefault()
        if (!validatePassword()) return

        try {
            const input: ChangePasswordInput = {
                userId: userInfo?._id || '', // Get user ID from Redux store
                oldPassword: passwordData.currentPassword,
                newPassword: passwordData.newPassword,
                confirmPassword: passwordData.confirmPassword
            }

            const result = await changePassword({
                variables: { input }
            })

            const response = result.data?.changePassword

            if (response?.status === 'success') {
                toast.success(response.message || 'Password changed successfully!')
                setPasswordData({ currentPassword: '', newPassword: '', confirmPassword: '' })
                const newDate = response.data?.updatedAt || new Date().toISOString()
                dispatch(setLastPasswordChanged(newDate))
            } else {
                toast.error(response?.message || 'Failed to change password')
            }
        } catch (error: any) {
            console.error('Password change error:', error)
            const errorMessage = error?.graphQLErrors?.[0]?.message || 
                                error?.message || 
                                'An unexpected error occurred. Please try again.'
            toast.error(errorMessage)
        }
    }



    const handleTwoFactorToggle = async () => {
        try {
            setUserEditLoading(true)
            
            const userId =  userInfo?._id || ''
            
            
            const input: UserEditInput = {
                userId: userId,
                is2FA: !twoFactorEnabled
            }
            
            console.log('üîç Input being sent:', input)

            const result = await userEditService(input)

            if (result.userEdit.status === 'success') {
                // Update authSlice
                dispatch(updateUser2FA(!twoFactorEnabled))
                // Update userSlice to keep both in sync
                await dispatch(getUser())
                toast.success(result.userEdit.message || '2FA setting updated successfully!')
            } else {
                toast.error(result.userEdit.message || 'Failed to update 2FA setting')
            }
        } catch (error: any) {
            console.error('2FA toggle error:', error)
            const errorMessage = error?.graphQLErrors?.[0]?.message || 
                                error?.message || 
                                'An unexpected error occurred. Please try again.'
            toast.error(errorMessage)
        } finally {
            setUserEditLoading(false)
        }
    }

    return (
        <DashboardLayout>
            <Box>
                <Box sx={{ pb: 3 }}>
                    <Typography variant="h5" fontWeight={600} fontFamily={'var(--font-inter), sans-serif'}>
                        Security
                    </Typography>
                    <Typography variant="subtitle1" color="#6c757d" fontFamily={'var(--font-inter), sans-serif'}>
                        Settings and recommendations to help you keep your account secure
                    </Typography>
                </Box>

                {/* Password Change Section */}
                <Card sx={{ borderRadius: '8px', border: '1px solid #e4e5e7', boxShadow: '0 2px 8px rgba(0,0,0,0.04)', mb: 3 }}>
                    <CardContent sx={{ p: 4 }}>
                        <Box sx={{ display: 'flex', alignItems: 'center', mb: 3 }}>
                            <Lock sx={{ color: '#408bff', mr: 2, fontSize: 28 }} />
                            <Box>
                                <Typography variant="h6" fontWeight={600} color="#1a1a1a">
                                    Password
                                </Typography>
                                {lastChangedDate && (
                                    <Typography variant="body2" color="#6b7280" sx={{ mt: 0.5 }}>
                                        Last changed: {new Date(lastChangedDate).toLocaleDateString('en-US', {
                                            year: 'numeric',
                                            month: 'long',
                                            day: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        })}
                                    </Typography>
                                )}
                            </Box>
                        </Box>

                        <Box component="form" id="password-form" onSubmit={handlePasswordSubmit}>
                            <Grid container spacing={3}>
                                <Grid size={4}>
                                    <TextField
                                        fullWidth
                                        label="Current Password"
                                        name="currentPassword"
                                        type={!showPasswords.current ? 'text' : 'password'}
                                        value={passwordData.currentPassword}
                                        onChange={handlePasswordChange}
                                        error={!!errors.currentPassword}
                                        helperText={errors.currentPassword}
                                        InputLabelProps={{
                                            shrink: true,
                                            sx: {
                                                fontSize: '0.95rem',
                                                color: '#9ca3af',
                                                '&.Mui-focused': { color: '#9ca3af' },
                                                transform: 'translate(14px, 16px) scale(1)',
                                                '&.MuiInputLabel-shrink': {
                                                    transform: 'translate(14px, -8px) scale(0.85)',
                                                    backgroundColor: '#fff',
                                                    px: 0.5,
                                                },
                                            },
                                        }}
                                        InputProps={{
                                            startAdornment: (
                                                <InputAdornment position="start" sx={{ pr: 0.5 }}>
                                                    <Lock sx={{ color: '#9ca3af', fontSize: 20 }} />
                                                    <Box sx={{ height: 28, width: 1.3, bgcolor: '#b0b0b0', ml: 1 }} />
                                                </InputAdornment>
                                            ),
                                            endAdornment: (
                                                <InputAdornment position="end">
                                                    <IconButton
                                                        onClick={() => setShowPasswords(prev => ({ ...prev, current: !prev.current }))}
                                                        edge="end"
                                                    >
                                                        {showPasswords.current ? <VisibilityOff /> : <Visibility />}
                                                    </IconButton>
                                                </InputAdornment>
                                            )
                                        }}
                                        sx={{
                                            '& .MuiOutlinedInput-root': {
                                                borderRadius: '12px',
                                                backgroundColor: '#fff',
                                                fontSize: '1rem',
                                                minHeight: '56px',
                                                '& fieldset': { borderColor: '#a8a8a8' },
                                                '&:hover fieldset': { borderColor: '#808080' },
                                                '&.Mui-focused fieldset': { borderColor: '#4285F4' },
                                            },
                                            '& .MuiOutlinedInput-input': { padding: '14px 10px' },
                                        }}
                                    />
                                </Grid>
                                <Grid size={4}>
                                    <TextField
                                        fullWidth
                                        label="New Password"
                                        name="newPassword"
                                        type={!showPasswords.new ? 'text' : 'password'}
                                        value={passwordData.newPassword}
                                        onChange={handlePasswordChange}
                                        error={!!errors.newPassword}
                                        helperText={errors.newPassword}
                                        InputLabelProps={{
                                            shrink: true,
                                            sx: {
                                                fontSize: '0.95rem',
                                                color: '#9ca3af',
                                                '&.Mui-focused': { color: '#9ca3af' },
                                                transform: 'translate(14px, 16px) scale(1)',
                                                '&.MuiInputLabel-shrink': {
                                                    transform: 'translate(14px, -8px) scale(0.85)',
                                                    backgroundColor: '#fff',
                                                    px: 0.5,
                                                },
                                            },
                                        }}
                                        InputProps={{
                                            startAdornment: (
                                                <InputAdornment position="start" sx={{ pr: 0.5 }}>
                                                    <Lock sx={{ color: '#9ca3af', fontSize: 20 }} />
                                                    <Box sx={{ height: 28, width: 1.3, bgcolor: '#b0b0b0', ml: 1 }} />
                                                </InputAdornment>
                                            ),
                                            endAdornment: (
                                                <InputAdornment position="end">
                                                    <IconButton
                                                        onClick={() => setShowPasswords(prev => ({ ...prev, new: !prev.new }))}
                                                        edge="end"
                                                    >
                                                        {showPasswords.new ? <VisibilityOff /> : <Visibility />}
                                                    </IconButton>
                                                </InputAdornment>
                                            )
                                        }}
                                        sx={{
                                            '& .MuiOutlinedInput-root': {
                                                borderRadius: '12px',
                                                backgroundColor: '#fff',
                                                fontSize: '1rem',
                                                minHeight: '56px',
                                                '& fieldset': { borderColor: '#a8a8a8' },
                                                '&:hover fieldset': { borderColor: '#808080' },
                                                '&.Mui-focused fieldset': { borderColor: '#4285F4' },
                                            },
                                            '& .MuiOutlinedInput-input': { padding: '14px 10px' },
                                        }}
                                    />
                                    <PasswordStrengthChecker password={passwordData.newPassword} />
                                </Grid>
                                <Grid size={4}>
                                    <TextField
                                        fullWidth
                                        label="Confirm New Password"
                                        name="confirmPassword"
                                        type={!showPasswords.confirm ? 'text' : 'password'}
                                        value={passwordData.confirmPassword}
                                        onChange={handlePasswordChange}
                                        error={!!errors.confirmPassword}
                                        helperText={errors.confirmPassword}
                                        InputLabelProps={{
                                            shrink: true,
                                            sx: {
                                                fontSize: '0.95rem',
                                                color: '#9ca3af',
                                                '&.Mui-focused': { color: '#9ca3af' },
                                                transform: 'translate(14px, 16px) scale(1)',
                                                '&.MuiInputLabel-shrink': {
                                                    transform: 'translate(14px, -8px) scale(0.85)',
                                                    backgroundColor: '#fff',
                                                    px: 0.5,
                                                },
                                            },
                                        }}
                                        InputProps={{
                                            startAdornment: (
                                                <InputAdornment position="start" sx={{ pr: 0.5 }}>
                                                    <Lock sx={{ color: '#9ca3af', fontSize: 20 }} />
                                                    <Box sx={{ height: 28, width: 1.3, bgcolor: '#b0b0b0', ml: 1 }} />
                                                </InputAdornment>
                                            ),
                                            endAdornment: (
                                                <InputAdornment position="end">
                                                    <IconButton
                                                        onClick={() => setShowPasswords(prev => ({ ...prev, confirm: !prev.confirm }))}
                                                        edge="end"
                                                    >
                                                        {showPasswords.confirm ? <VisibilityOff /> : <Visibility />}
                                                    </IconButton>
                                                </InputAdornment>
                                            )
                                        }}
                                        sx={{
                                            '& .MuiOutlinedInput-root': {
                                                borderRadius: '12px',
                                                backgroundColor: '#fff',
                                                fontSize: '1rem',
                                                minHeight: '56px',
                                                '& fieldset': { borderColor: '#a8a8a8' },
                                                '&:hover fieldset': { borderColor: '#808080' },
                                                '&.Mui-focused fieldset': { borderColor: '#4285F4' },
                                            },
                                            '& .MuiOutlinedInput-input': { padding: '14px 10px' },
                                        }}
                                    />
                                </Grid>
                            </Grid>

                            <Box sx={{ mt: 3, display: 'flex', justifyContent: 'flex-end' }}>
                                <Button
                                    type="submit"
                                    variant="contained"
                                    disabled={passwordLoading}
                                    sx={{
                                        backgroundColor: '#408bff',
                                        '&:hover': {
                                            backgroundColor: '#3a7de6',
                                        },
                                        '&:disabled': {
                                            backgroundColor: '#9ca3af',
                                        },
                                        textTransform: 'none',
                                        borderRadius: '8px',
                                        px: 4,
                                        py: 1.2,
                                        fontWeight: 500,
                                        boxShadow: '0 2px 8px rgba(64, 139, 255, 0.25)',
                                        minWidth: 160
                                    }}
                                >
                                    {passwordLoading ? (
                                        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                                            <CircularProgress size={16} color="inherit" />
                                            Updating...
                                        </Box>
                                    ) : (
                                        'Update Password'
                                    )}
                                </Button>
                            </Box>
                        </Box>
                    </CardContent>
                </Card>

                {/* Two-Factor Authentication Section */}
                <Card sx={{ borderRadius: '8px', border: '1px solid #e4e5e7', boxShadow: '0 2px 8px rgba(0,0,0,0.04)' }}>
                    <CardContent sx={{ p: 4 }}>
                        <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                            <Box sx={{ display: 'flex', alignItems: 'center' }}>
                                <Shield sx={{ color: '#408bff', mr: 2, fontSize: 28 }} />
                                <Box>
                                    <Typography variant="h6" fontWeight={600} color="#1a1a1a">
                                        Two-Factor Authentication
                                    </Typography>
                                    <Typography variant="body2" color="#6b7280">
                                        Add an extra layer of security to your account
                                    </Typography>
                                </Box>
                            </Box>
                            <Switch
                                checked={twoFactorEnabled}
                                onChange={handleTwoFactorToggle}
                                disabled={userEditLoading}
                                sx={{
                                    width: 48,
                                    height: 28,
                                    padding: 0,
                                    '& .MuiSwitch-switchBase': {
                                        padding: 0,
                                        margin: '2px',
                                        transitionDuration: '300ms',
                                        '&.Mui-checked': {
                                            transform: 'translateX(20px)',
                                            color: '#fff',
                                            '& + .MuiSwitch-track': {
                                                backgroundColor: '#408bff',
                                                opacity: 1,
                                                border: 0,
                                            },
                                            '&.Mui-disabled + .MuiSwitch-track': {
                                                opacity: 0.5,
                                            },
                                        },
                                        '&.Mui-focusVisible .MuiSwitch-thumb': {
                                            color: '#408bff',
                                            border: '6px solid #fff',
                                        },
                                        '&.Mui-disabled .MuiSwitch-thumb': {
                                            color: '#f4f3f4',
                                        },
                                        '&.Mui-disabled + .MuiSwitch-track': {
                                            opacity: 0.7,
                                        },
                                    },
                                    '& .MuiSwitch-thumb': {
                                        boxSizing: 'border-box',
                                        width: 24,
                                        height: 24,
                                        backgroundColor: '#fff',
                                        boxShadow: '0 2px 4px rgba(0,0,0,0.2)',
                                    },
                                    '& .MuiSwitch-track': {
                                        borderRadius: 14,
                                        backgroundColor: '#e5e7eb',
                                        opacity: 1,
                                        transition: 'background-color 300ms cubic-bezier(0.4, 0, 0.2, 1)',
                                    },
                                }}
                            />
                        </Box>
                    </CardContent>
                </Card>
            </Box>
        </DashboardLayout>
    )
}

export default withPageLoader(Security);
